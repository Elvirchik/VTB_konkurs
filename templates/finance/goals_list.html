{% extends "base.html" %}
{% block title %}Цели{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Финансовые цели</h2>
  <a href="{% url 'finance:goal_create' %}" class="btn btn-primary">Добавить цель</a>
</div>
<div class="row">
  {% for goal in goals %}
  <div class="col-md-6 mb-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <h5 class="card-title mb-1">{{ goal.name }}</h5>
          <span class="small text-muted">
            {{ goal.current_amount }} / {{ goal.target_amount }} ₽
          </span>
        </div>

        <div class="progress mt-2" style="height: 10px;">
  {% with p=goal.progress_percent %}
    {% if p < 0 %}
      {% with p=0 %}
      {% endwith %}
    {% elif p > 100 %}
      {% with p=100 %}
      {% endwith %}
    {% endif %}
    <div class="progress-bar {% if goal.is_completed %}bg-success{% else %}bg-info{% endif %}"
         role="progressbar"
         style="width: {{ goal.progress_percent|floatformat:0 }}%;"
         aria-valuenow="{{ goal.progress_percent|floatformat:0 }}"
         aria-valuemin="0"
         aria-valuemax="100">
    </div>
  {% endwith %}
</div>


        {% if goal.deadline %}
        <p class="mt-2 mb-0 small text-muted">Дедлайн: {{ goal.deadline }}</p>
        {% endif %}
        {% if goal.is_completed %}
        <p class="text-success mt-1 mb-0 small">
          Цель уже выполнена, время реализации.
        </p>
        {% endif %}

        <!-- Форма добавления суммы — только если цель не выполнена -->
        {% if not goal.is_completed %}
        <form method="post"
              action="{% url 'finance:goal_add_amount' goal.pk %}"
              class="mt-3 row g-2">
          {% csrf_token %}
          <div class="col-7">
            <input type="number"
                   name="amount"
                   step="0.01"
                   min="0.01"
                   class="form-control"
                   placeholder="Добавить сумму">
          </div>
          <div class="col-5">
            <button type="submit" class="btn btn-outline-success w-100">
              Добавить
            </button>
          </div>
        </form>
        {% endif %}

        <div class="mt-3 d-flex justify-content-end">
          <a href="{% url 'finance:goal_update' goal.pk %}" class="btn btn-sm btn-outline-secondary me-2">
            Изменить
          </a>
          <form method="post" action="{% url 'finance:goal_delete' goal.pk %}">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Удалить цель?');">
              Удалить
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-muted">Пока нет целей. Создайте первую!</p>
  {% endfor %}
</div>
{% endblock %}
